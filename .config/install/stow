#!/usr/bin/env zsh

# Skip if stow already installed
if [[ -x "$LOCAL_PREFIX/bin/stow" ]] || command -v stow &>/dev/null; then
    return 0 2>/dev/null || exit 0
fi

# Check dependencies
for cmd in perl curl tar make; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is required but not installed"
        return 1 2>/dev/null || exit 1
    fi
done

# Get latest version from GNU FTP directory listing
VERSION=$(curl -fsSL "https://ftp.gnu.org/gnu/stow/" | grep -oE 'stow-[0-9]+\.[0-9]+(\.[0-9]+)?\.tar\.gz' | sort -V | tail -1 | sed -E 's/stow-(.*)\.tar\.gz/\1/')
[[ -z "$VERSION" ]] && VERSION="2.4.0"

URL="https://ftp.gnu.org/gnu/stow/stow-${VERSION}.tar.gz"
TMPDIR=$(mktemp -d)
trap "rm -rf '$TMPDIR'" EXIT

mkdir -p "$PREFIX"

(
    cd "$TMPDIR"
    echo "Downloading stow ${VERSION}..."
    curl -fsSL "$URL" -o stow.tar.gz || exit 1
    tar xf stow.tar.gz
    cd "stow-${VERSION}"

    echo "Configuring..."
    ./configure --prefix="$PREFIX" || exit 1

    echo "Installing to $PREFIX..."
    make install || exit 1
)

