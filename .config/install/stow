#!/usr/bin/env zsh

# Skip if stow already installed
if [[ -x "$LOCAL_PREFIX/bin/stow" ]] || command -v stow >/dev/null 2>&1; then
    return 0 2>/dev/null || exit 0
fi

# Check dependencies
for cmd in perl curl tar make; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is required but not installed"
        return 1 2>/dev/null || exit 1
    fi
done

# Build from source
STOW_VERSION="2.4.0"
STOW_URL="https://ftp.gnu.org/gnu/stow/stow-${STOW_VERSION}.tar.gz"
BUILD_DIR="/tmp/stow-build-$$"

mkdir -p "$BUILD_DIR" "$PREFIX"

(
    cd "$BUILD_DIR"

    echo "Downloading stow ${STOW_VERSION}..."
    curl -L "$STOW_URL" -o stow.tar.gz || exit 1
    tar xf stow.tar.gz
    cd "stow-${STOW_VERSION}"

    echo "Configuring..."
    ./configure --prefix="$PREFIX" || exit 1

    echo "Installing to $PREFIX..."
    make install || exit 1
) || { rm -rf "$BUILD_DIR"; return 1; }

rm -rf "$BUILD_DIR"
