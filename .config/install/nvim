#!/usr/bin/env zsh

# Check if sudo is available (not blocked/fake)
has_sudo() {
    command -v sudo >/dev/null 2>&1 || return 1
    sudo -n true 2>&1 | grep -qiE "(no sudo|not allowed|sorry)" && return 1
    return 0
}

if ! command -v nvim &> /dev/null; then
    pushd /tmp > /dev/null
    rm -rf neovim
    git clone --depth 1 https://github.com/neovim/neovim
    cd neovim

    JOBS=$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 1)

    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        COMPAT_FLAGS="-gdwarf-4 -D_DEFAULT_SOURCE -D_BSD_SOURCE"
        make -j"$JOBS" CMAKE_BUILD_TYPE=RelWithDebInfo \
            CMAKE_EXTRA_FLAGS="-DCMAKE_C_FLAGS='$COMPAT_FLAGS' -DCMAKE_CXX_FLAGS='$COMPAT_FLAGS'" \
            DEPS_CMAKE_FLAGS="-DCMAKE_C_FLAGS='$COMPAT_FLAGS' -DCMAKE_CXX_FLAGS='$COMPAT_FLAGS'"
    else
        make -j"$JOBS" CMAKE_BUILD_TYPE=RelWithDebInfo
    fi

    if has_sudo; then
        sudo make install CMAKE_INSTALL_PREFIX="/usr/local"
    else
        make install CMAKE_INSTALL_PREFIX="$HOME/.local"
    fi

    popd > /dev/null
    rm -rf /tmp/neovim
fi
