#!/usr/bin/env zsh

# Check if sudo is available (not blocked/fake)
has_sudo() {
    command -v sudo >/dev/null 2>&1 || return 1
    sudo -n true 2>&1 | grep -qiE "(no sudo|not allowed|sorry)" && return 1
    return 0
}

if ! command -v nvim &> /dev/null; then
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Use pre-built AppImage on Linux
        mkdir -p "$HOME/.local/bin"
        curl -Lo "$HOME/.local/bin/nvim" \
            https://github.com/neovim/neovim/releases/download/stable/nvim-linux-x86_64.appimage
        chmod +x "$HOME/.local/bin/nvim"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # Build from source on macOS
        pushd /tmp > /dev/null
        rm -rf neovim
        git clone --depth 1 https://github.com/neovim/neovim
        cd neovim

        JOBS=$(sysctl -n hw.ncpu 2>/dev/null || echo 1)
        make -j"$JOBS" CMAKE_BUILD_TYPE=RelWithDebInfo

        if has_sudo; then
            sudo make install CMAKE_INSTALL_PREFIX="/usr/local"
        else
            make install CMAKE_INSTALL_PREFIX="$HOME/.local"
        fi

        popd > /dev/null
        rm -rf /tmp/neovim
    fi
fi
