#!/usr/bin/env zsh

# Check dependencies
if ! command -v curl &>/dev/null; then
    echo "Error: curl is required but not installed"
    return 1 2>/dev/null || exit 1
fi

mkdir -p "$PREFIX/bin"

# Determine platform and architecture
case "$(uname -s)" in
    Darwin) OS="darwin"; FD_OS="apple-darwin" ;;
    Linux)  OS="linux"; FD_OS="unknown-linux-gnu" ;;
    *)      echo "Unsupported OS"; return 1 2>/dev/null || exit 1 ;;
esac

case "$(uname -m)" in
    x86_64)        ARCH="amd64"; FD_ARCH="x86_64" ;;
    arm64|aarch64) ARCH="arm64"; FD_ARCH="aarch64" ;;
    *)             echo "Unsupported architecture"; return 1 2>/dev/null || exit 1 ;;
esac

# Install fzf
if [[ ! -x "$LOCAL_PREFIX/bin/fzf" ]] && ! command -v fzf &>/dev/null; then
    VERSION=$(curl -fsSL "https://api.github.com/repos/junegunn/fzf/releases/latest" | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    [[ -z "$VERSION" ]] && { echo "Failed to get fzf version"; return 1 2>/dev/null || exit 1; }

    URL="https://github.com/junegunn/fzf/releases/download/v${VERSION}/fzf-${VERSION}-${OS}_${ARCH}.tar.gz"
    TMPDIR=$(mktemp -d)
    trap "rm -rf '$TMPDIR'" EXIT

    curl -fsSL "$URL" -o "$TMPDIR/fzf.tar.gz" || return 1
    tar -xzf "$TMPDIR/fzf.tar.gz" -C "$TMPDIR" || return 1
    mv "$TMPDIR/fzf" "$PREFIX/bin/fzf" || return 1
    chmod +x "$PREFIX/bin/fzf"
    echo "Installed fzf $VERSION"
fi

# Install fd (used by fzf for file finding)
if [[ ! -x "$LOCAL_PREFIX/bin/fd" ]] && ! command -v fd &>/dev/null; then
    VERSION=$(curl -fsSL "https://api.github.com/repos/sharkdp/fd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    [[ -z "$VERSION" ]] && { echo "Failed to get fd version"; return 1 2>/dev/null || exit 1; }

    URL="https://github.com/sharkdp/fd/releases/download/v${VERSION}/fd-v${VERSION}-${FD_ARCH}-${FD_OS}.tar.gz"
    TMPDIR=$(mktemp -d)
    trap "rm -rf '$TMPDIR'" EXIT

    curl -fsSL "$URL" -o "$TMPDIR/fd.tar.gz" || return 1
    tar -xzf "$TMPDIR/fd.tar.gz" -C "$TMPDIR" || return 1
    mv "$TMPDIR"/fd-*/fd "$PREFIX/bin/fd" || return 1
    chmod +x "$PREFIX/bin/fd"
    echo "Installed fd $VERSION"
fi
