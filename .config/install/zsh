#!/usr/bin/env zsh

# Skip if zsh already installed
if [[ -x "$LOCAL_PREFIX/bin/zsh" ]] || command -v zsh &>/dev/null; then
    return 0 2>/dev/null || exit 0
fi

# Check dependencies
for cmd in curl tar make; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is required but not installed"
        return 1 2>/dev/null || exit 1
    fi
done

# Get latest stable version from GitHub tags
VERSION=$(curl -fsSL "https://api.github.com/repos/zsh-users/zsh/tags" | grep -oE '"name": "zsh-[0-9]+\.[0-9]+(\.[0-9]+)?"' | head -1 | sed -E 's/.*"zsh-([^"]+)".*/\1/')
[[ -z "$VERSION" ]] && VERSION="5.9"

URL="https://sourceforge.net/projects/zsh/files/zsh/${VERSION}/zsh-${VERSION}.tar.gz/download"
TMPDIR=$(mktemp -d)
trap "rm -rf '$TMPDIR'" EXIT

mkdir -p "$PREFIX"

(
    cd "$TMPDIR"
    echo "Downloading zsh ${VERSION}..."
    curl -fsSL "$URL" -o zsh.tar.gz || exit 1
    tar xf zsh.tar.gz
    cd "zsh-${VERSION}"

    echo "Configuring..."
    ./configure --prefix="$PREFIX" || exit 1

    echo "Building..."
    make -j"$JOBS" || exit 1

    echo "Installing to $PREFIX..."
    make install || exit 1
) || { echo "Build failed"; return 1 2>/dev/null || exit 1; }

# Add zsh exec to .bashrc if not already present (only for local installs)
if (( ! USE_SUDO )); then
    BASHRC="$HOME/.bashrc"
    EXEC_LINE='[ -x "$HOME/.local/bin/zsh" ] && unset PS1 && export MODULESHOME && exec "$HOME/.local/bin/zsh" -l'

    if [[ -f "$BASHRC" ]]; then
        if ! grep -qF '.local/bin/zsh' "$BASHRC"; then
            echo "$EXEC_LINE" >> "$BASHRC"
        fi
    else
        echo "$EXEC_LINE" > "$BASHRC"
    fi
fi

echo "zsh installed to $PREFIX/bin/zsh"
