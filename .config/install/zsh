#!/usr/bin/env zsh

# Skip if zsh already installed
if command -v zsh >/dev/null 2>&1; then
    return 0 2>/dev/null || exit 0
fi

# Check dependencies
for cmd in curl tar make; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is required but not installed"
        return 1 2>/dev/null || exit 1
    fi
done

# Build from source
ZSH_VERSION="5.9"
ZSH_URL="https://sourceforge.net/projects/zsh/files/zsh/${ZSH_VERSION}/zsh-${ZSH_VERSION}.tar.gz/download"
BUILD_DIR="/tmp/zsh-build-$$"

mkdir -p "$BUILD_DIR" "$PREFIX"

(
    cd "$BUILD_DIR"

    echo "Downloading zsh ${ZSH_VERSION}..."
    curl -L "$ZSH_URL" -o zsh.tar.gz || exit 1
    tar xf zsh.tar.gz
    cd "zsh-${ZSH_VERSION}"

    echo "Configuring..."
    ./configure --prefix="$PREFIX" || exit 1

    echo "Building..."
    make -j"$JOBS" || exit 1

    echo "Installing to $PREFIX..."
    make install || exit 1
) || { rm -rf "$BUILD_DIR"; return 1; }

rm -rf "$BUILD_DIR"

# Add zsh exec to .bashrc if not already present (only for local installs)
if (( ! USE_SUDO )); then
    BASHRC="$HOME/.bashrc"
    EXEC_LINE='[ -x "$HOME/.local/bin/zsh" ] && unset PS1 && export MODULESHOME && exec "$HOME/.local/bin/zsh" -l'

    if [[ -f "$BASHRC" ]]; then
        if ! grep -qF '.local/bin/zsh' "$BASHRC"; then
            echo "$EXEC_LINE" >> "$BASHRC"
        fi
    else
        echo "$EXEC_LINE" > "$BASHRC"
    fi
fi

echo "zsh installed to $PREFIX/bin/zsh"
