#!/usr/bin/env zsh

# Skip if zsh already installed
if [[ -x "$LOCAL_PREFIX/bin/zsh" ]] || command -v zsh &>/dev/null; then
    return 0 2>/dev/null || exit 0
fi

# Check dependencies
for cmd in curl tar make; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is required but not installed"
        return 1 2>/dev/null || exit 1
    fi
done

# Check for ncurses development headers
check_ncurses() {
    # Try pkg-config first
    pkg-config --exists ncurses 2>/dev/null && return 0
    pkg-config --exists ncursesw 2>/dev/null && return 0
    # Check common header locations
    for dir in /usr/include /usr/local/include /opt/local/include; do
        [[ -f "$dir/ncurses.h" || -f "$dir/curses.h" || -f "$dir/ncurses/ncurses.h" ]] && return 0
    done
    return 1
}

if ! check_ncurses; then
    echo "Error: ncurses development headers not found"
    if command -v apt-get &>/dev/null; then
        echo "Install with: sudo apt-get install libncurses-dev"
    elif command -v dnf &>/dev/null; then
        echo "Install with: sudo dnf install ncurses-devel"
    elif command -v yum &>/dev/null; then
        echo "Install with: sudo yum install ncurses-devel"
    elif command -v brew &>/dev/null; then
        echo "Install with: brew install ncurses"
    fi
    return 1 2>/dev/null || exit 1
fi

# Get latest stable version from GitHub tags
VERSION=$(curl -fsSL "https://api.github.com/repos/zsh-users/zsh/tags" | grep -oE '"name": "zsh-[0-9]+\.[0-9]+(\.[0-9]+)?"' | head -1 | sed -E 's/.*"zsh-([^"]+)".*/\1/')
[[ -z "$VERSION" ]] && VERSION="5.9"

URL="https://sourceforge.net/projects/zsh/files/zsh/${VERSION}/zsh-${VERSION}.tar.xz/download"
TMPDIR=$(mktemp -d)
trap "rm -rf '$TMPDIR'" EXIT

mkdir -p "$PREFIX"

(
    cd "$TMPDIR"
    echo "Downloading zsh ${VERSION}..."
    curl -fsSL -L "$URL" -o zsh.tar.xz || exit 1
    tar xf zsh.tar.xz
    cd "zsh-${VERSION}"

    echo "Configuring..."
    ./configure --prefix="$PREFIX" || exit 1

    echo "Building..."
    make -j"$JOBS" || exit 1

    echo "Installing to $PREFIX..."
    make install || exit 1
) || { echo "Build failed"; return 1 2>/dev/null || exit 1; }

# Post-install setup
if (( USE_SUDO )); then
    # Add to /etc/shells for chsh compatibility
    if ! grep -qF "$PREFIX/bin/zsh" /etc/shells 2>/dev/null; then
        echo "$PREFIX/bin/zsh" >> /etc/shells
    fi
else
    # Add zsh exec to .bashrc for local installs
    BASHRC="$HOME/.bashrc"
    EXEC_LINE='[ -x "$HOME/.local/bin/zsh" ] && unset PS1 && export MODULESHOME && exec "$HOME/.local/bin/zsh" -l'

    if [[ -f "$BASHRC" ]]; then
        if ! grep -qF '.local/bin/zsh' "$BASHRC"; then
            echo "$EXEC_LINE" >> "$BASHRC"
        fi
    else
        echo "$EXEC_LINE" > "$BASHRC"
    fi
fi

echo "zsh installed to $PREFIX/bin/zsh"
