#!/usr/bin/env zsh

# Check if ninja exists and is a real binary (not a broken Python wrapper)
_ninja_ok() {
    local ninja_path=$(command -v ninja 2>/dev/null)
    [[ -z "$ninja_path" ]] && return 1
    [[ "$(head -c 2 "$ninja_path" 2>/dev/null)" == "#!" ]] && return 1
    return 0
}

if [[ -x "$LOCAL_PREFIX/bin/ninja" ]] || _ninja_ok; then
    return 0 2>/dev/null || exit 0
fi

# Determine platform and architecture
case "$OSTYPE" in
    darwin*)    PLATFORM="mac" ;;
    linux-gnu*)
        case "$(uname -m)" in
            aarch64|arm64) PLATFORM="linux-aarch64" ;;
            *)             PLATFORM="linux" ;;
        esac
        ;;
    *)          echo "Error: Unsupported platform: $OSTYPE"; return 1 2>/dev/null || exit 1 ;;
esac

# Get latest release version
VERSION=$(curl -fsSL "https://api.github.com/repos/ninja-build/ninja/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
[[ -z "$VERSION" ]] && VERSION="v1.12.1"

URL="https://github.com/ninja-build/ninja/releases/download/${VERSION}/ninja-${PLATFORM}.zip"
TMPDIR=$(mktemp -d)
trap "rm -rf '$TMPDIR'" EXIT

echo "Downloading ninja ${VERSION} for ${PLATFORM}..."
curl -fsSL "$URL" -o "$TMPDIR/ninja.zip" || { echo "Error: Failed to download ninja"; return 1 2>/dev/null || exit 1; }

unzip -q "$TMPDIR/ninja.zip" -d "$TMPDIR"
mkdir -p "$PREFIX/bin"

# Remove broken Python wrapper if it exists
[[ -f "$PREFIX/bin/ninja" ]] && rm -f "$PREFIX/bin/ninja"

mv "$TMPDIR/ninja" "$PREFIX/bin/"
chmod +x "$PREFIX/bin/ninja"
