#!/usr/bin/env zsh

if ! command -v btop &> /dev/null; then
    # Check dependencies
    if ! command -v git &>/dev/null; then
        echo "Error: git is required but not installed"
        return 1
    fi

    # Set make command (brew dependencies installed by main install script)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        if ! command -v gmake &>/dev/null; then
            echo "Error: gmake not found. Install with: brew install make"
            return 1
        fi
        MAKE="gmake"
    else
        MAKE="make"
    fi

    pushd /tmp > /dev/null
    rm -rf btop

    # Use v1.3.2 for GCC < 13 (lacks full C++23 std::ranges::to support)
    GCC_VER=$(${CXX:-c++} -dumpversion 2>/dev/null | cut -d. -f1)
    if [[ -n "$GCC_VER" && "$GCC_VER" -lt 13 ]]; then
        BTOP_TAG="v1.3.2"
    else
        BTOP_TAG=""  # latest
    fi

    if [[ -n "$BTOP_TAG" ]]; then
        git clone --depth 1 --branch "$BTOP_TAG" https://github.com/aristocratos/btop.git
    else
        git clone --depth 1 https://github.com/aristocratos/btop.git
    fi
    cd btop

    $MAKE -j"$JOBS" PREFIX="$PREFIX" || { popd > /dev/null; rm -rf /tmp/btop; return 1; }
    $MAKE install PREFIX="$PREFIX" || { popd > /dev/null; rm -rf /tmp/btop; return 1; }
    [[ "$OSTYPE" == "linux-gnu"* ]] && $MAKE setcap

    popd > /dev/null
    rm -rf /tmp/btop
fi
