#!/usr/bin/env bash
# Bootstrap script for fresh machines
# Usage: git clone <repo> ~/.dotfiles && ~/.dotfiles/bootstrap

set -e

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"
LOCAL_PREFIX="$HOME/.local"
LOG_DIR="$LOCAL_PREFIX/log/install"

# Colors
_GREEN='\033[0;32m'
_RED='\033[0;31m'
_CYAN='\033[0;36m'
_NC='\033[0m'

info() { printf "${_CYAN}==> %s${_NC}\n" "$1"; }
success() { printf "${_GREEN}==> %s${_NC}\n" "$1"; }
error() { printf "${_RED}==> %s${_NC}\n" "$1" >&2; }
detail() { printf "    %s\n" "$1"; }

mkdir -p "$LOG_DIR"

# ─────────────────────────────────────────────────────────────────────────────
# Step 0: Check prerequisites
# ─────────────────────────────────────────────────────────────────────────────

info "Checking prerequisites..."
MISSING=""
for cmd in git curl make perl tar; do
  if command -v "$cmd" &>/dev/null; then
    detail "$cmd: $(command -v "$cmd")"
  else
    MISSING="$MISSING $cmd"
  fi
done

if [[ -n "$MISSING" ]]; then
  error "Missing required tools:$MISSING"
  if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "Install Xcode Command Line Tools: xcode-select --install" >&2
  elif command -v apt-get &>/dev/null; then
    echo "Install with: sudo apt-get install$MISSING" >&2
  elif command -v dnf &>/dev/null; then
    echo "Install with: sudo dnf install$MISSING" >&2
  fi
  exit 1
fi
success "All prerequisites found"

# ─────────────────────────────────────────────────────────────────────────────
# Step 1: Install stow (needed to symlink dotfiles)
# ─────────────────────────────────────────────────────────────────────────────

if command -v stow &>/dev/null; then
  info "stow already installed: $(command -v stow)"
elif [[ -x "$LOCAL_PREFIX/bin/stow" ]]; then
  info "stow already installed: $LOCAL_PREFIX/bin/stow"
  export PATH="$LOCAL_PREFIX/bin:$PATH"
else
  info "Installing stow..."
  detail "Log: $LOG_DIR/stow.log"
  export PREFIX="$LOCAL_PREFIX"
  if source "$DOTFILES_DIR/.config/install/stow" > "$LOG_DIR/stow.log" 2>&1; then
    export PATH="$LOCAL_PREFIX/bin:$PATH"
    success "stow installed to $LOCAL_PREFIX/bin/stow"
  else
    error "Failed to install stow (see $LOG_DIR/stow.log)"
    exit 1
  fi
fi

# ─────────────────────────────────────────────────────────────────────────────
# Step 2: Stow dotfiles
# ─────────────────────────────────────────────────────────────────────────────

info "Linking dotfiles..."
detail "Source: $DOTFILES_DIR"
detail "Target: $HOME"
cd "$DOTFILES_DIR"
if stow . -t ~ 2>"$LOG_DIR/stow-link.log"; then
  success "Dotfiles linked"
else
  error "Failed to link dotfiles (see $LOG_DIR/stow-link.log)"
  exit 1
fi

# ─────────────────────────────────────────────────────────────────────────────
# Step 3: Run shell setup (installs zsh if needed, then remaining tools)
# ─────────────────────────────────────────────────────────────────────────────

info "Running shell setup..."
if command -v zsh &>/dev/null; then
  detail "zsh: $(command -v zsh)"
  detail "Sourcing $HOME/.zprofile"
  zsh -c "source '$HOME/.zprofile'"
else
  # Install zsh first, then run setup
  info "Installing zsh (not found in PATH)..."
  detail "Log: $LOG_DIR/zsh.log"
  export PREFIX="$LOCAL_PREFIX"
  export LOCAL_PREFIX
  export GLOBAL_PREFIX="/usr/local"
  if bash "$DOTFILES_DIR/.config/install/zsh" > "$LOG_DIR/zsh.log" 2>&1; then
    success "zsh installed to $LOCAL_PREFIX/bin/zsh"
    export PATH="$LOCAL_PREFIX/bin:$PATH"
    detail "Sourcing $HOME/.zprofile"
    zsh -c "source '$HOME/.zprofile'"
  else
    error "Failed to install zsh (see $LOG_DIR/zsh.log)"
    exit 1
  fi
fi

success "Bootstrap complete! Run 'exec zsh -l' to start your new shell."
